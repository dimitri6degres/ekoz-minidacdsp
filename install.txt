install

sudo raspi-config nonint do_hostname ekoz-minidacdsp
sudo hostnamectl set-hostname "ekoz-minidacdsp" --pretty

cp /boot/ekoz-minidacdsp.xml /home/pi/.
cp -R /boot/ekozGATT /home/pi/.

reboot


sudo nano /etc/asound.conf
------------
defaults.pcm.card 0
defaults.ctl.card 0

pcm.hifiberry {
  type hw
  card 0
  device 0
}
pcm.dmixer {
  type dmix
  ipc_key 1024
  ipc_perm 0666
  slave.pcm "hifiberry"
  slave {
    period_time 0
    period_size 1024
    buffer_size 8192
    rate 44100
    format S32_LE
  }
  bindings {
    0 0
    1 1
  }
}
ctl.dmixer {
  type hw
  card 0
}
pcm.softvol {
  type softvol
  slave.pcm "dmixer"
  control {
    name "Softvol"
    card 0
  }
  min_dB -90.2
  max_dB 0.0
}
pcm.!default {
  type plug
  slave.pcm "softvol"
}
-------------


sudo sed -i.orig 's/^options snd-usb-audio index=-2$/#options snd-usb-audio index=-2/' /lib/modprobe.d/aliases.conf
mkdir -p /etc/systemd/system/bluealsa.service.d
sudo mkdir -p /etc/systemd/system/bluealsa.service.d
sudo nano /etc/systemd/system/bluealsa.service.d/override.conf
----------
[Service]
ExecStart=
ExecStart=/usr/bin/bluealsa -i hci0 -p a2dp-sink
RestartSec=5
Restart=always
------------
sudo nano /etc/systemd/system/bluealsa-aplay.service
-----------
[Unit]
Description=BlueALSA aplay
Requires=bluealsa.service
After=bluealsa.service sound.target

[Service]
Type=simple
User=root
ExecStartPre=/bin/sleep 2
ExecStart=/usr/bin/bluealsa-aplay --pcm-buffer-time=250000 00:00:00:00:00:00
RestartSec=5
Restart=always

[Install]
WantedBy=multi-user.target
-----------------
sudo nano /etc/systemd/system/bt-agent.service
---------
[Unit]
Description=Bluetooth Agent
Requires=bluetooth.service
After=bluetooth.service

[Service]
ExecStart=/usr/bin/bt-agent --capability=NoInputNoOutput
RestartSec=5
Restart=always
KillSignal=SIGUSR1

[Install]
WantedBy=multi-user.target
------------


sudo nano /usr/local/bin/bluetooth-udev
---------
#!/bin/bash
if [[ ! $NAME =~ ^\"([0-9A-F]{2}[:-]){5}([0-9A-F]{2})\"$ ]]; then exit 0; fi

action=$(expr "$ACTION" : "\([a-zA-Z]\+\).*")

if [ "$action" = "add" ]; then
    bluetoothctl discoverable off
    # disconnect wifi to prevent dropouts
    #ifconfig wlan0 down &
fi

if [ "$action" = "remove" ]; then
    # reenable wifi
    #ifconfig wlan0 up &
    #bluetoothctl discoverable on
fi
------------
sudo chmod 755 /usr/local/bin/bluetooth-udev
sudo nano /etc/udev/rules.d/99-bluetooth-udev.rules
---------
SUBSYSTEM=="input", GROUP="input", MODE="0660"
KERNEL=="input[0-9]*", RUN+="/usr/local/bin/bluetooth-udev"
---------
sudo sed -i 's/bluetoothd/bluetoothd -E/' /lib/systemd/system/bluetooth.service
sudo nano /etc/systemd/system/ekoz-minidacdsp.service
-------------
[Unit]
Description=Ekoz-minidacdsp
Requires=bluetooth.service
After=bluetooth.service

[Service]
ExecStart=/usr/bin/python3 /home/pi/ekozGATT/ekozGATT.py
RestartSec=5
Restart=always

[Install]
WantedBy=multi-user.target
-------------

sudo mkdir -p /var/lib/hifiberry


sudo nano /lib/systemd/system/sigmatcp.service
---------
[Unit]
Description=SigmaTCP Server for HiFiBerry DSP
Wants=network-online.target
After=network.target network-online.target
[Service]
Type=simple
ExecStart=/usr/local/bin/sigmatcpserver --alsa
StandardOutput=journal
[Install]
WantedBy=multi-user.target
---------

sudo sed -i 's/#Class = 0x000100/Class = 0x200414/' /etc/bluetooth/main.conf

sudo adduser pi bluetooth
sudo adduser pi lp
sudo hciconfig hci0 piscan
sudo hciconfig hci0 sspmode 1

sudo apt-get update
sudo apt-get install -y python3-pip libxslt1-dev libxml2-dev zlib1g-dev python3-lxml python-lxml libxml2-dev libxslt-dev python-dev  python3-dbus alsa-base alsa-utils bluealsa bluez-tools

sudo pip3 install hifiberrydsp gpiozero

------------

sudo systemctl daemon-reload



sudo systemctl enable bluealsa-aplay
sudo systemctl enable bt-agent.service
sudo systemctl enable ekoz-minidacdsp.service
sudo systemctl enable sigmatcp.service 

sudo service sigmatcp start
dsptoolkit install-profile /home/pi/ekoz-minidacdsp.xml
 
 
sudo service bluetooth restart
sudo service bluealsa-aplay start
sudo service bt-agent start
sudo service ekoz-minidacdsp start


sudo reboot
